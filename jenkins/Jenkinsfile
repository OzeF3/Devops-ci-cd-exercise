pipeline {
    agent any

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['staging', 'production'],
            description: 'Run performance tests only in production')
        
    }

    environment {
        VENV_DIR = 'venv'
        DOCKERHUB_REPO = 'devoeoe23ops/devops-testing-app'
        DOCKERHUB_CREDS = 'dockerhub-creds'
        PY_IMAGE = 'python:3.9'
        APP_DIR = '/app'
    }

    stages {


        stage('Demo: Fail only in production (Jira)') {
  when { expression { params.ENVIRONMENT == 'production' } }
  steps {
    error('Demo failure: ENVIRONMENT=production (should trigger Jira issue)')
  }
}


        

        stage('Verify Docker (host)') {
            steps {
                
                sh 'docker --version'
                sh 'docker info'
                sh 'docker ps'
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    sh 'pwd && ls -la'
                    sh 'echo "Setting up Python environment (inside docker run)"'
                    sh """
                        docker run --rm --volumes-from jenkins \
                        -w /var/jenkins_home/workspace/devops-ci-cd \
                        python:3.9 bash -lc "pwd && ls -la && python -m venv venv && . venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt"



                    """
                }
            }
        }

        stage('Lint Code') {
            steps {
                script {
                    sh 'mkdir -p reports'
                    sh """
                    docker run --rm --volumes-from jenkins -w /var/jenkins_home/workspace/devops-ci-cd python:3.9 bash -lc ". venv/bin/activate && flake8 app/ --output-file=reports/flake8.txt || true"
                    """
                    sh """
                    docker run --rm --volumes-from jenkins -w /var/jenkins_home/workspace/devops-ci-cd python:3.9 bash -lc ". venv/bin/activate && pylint app/ --output=reports/pylint.txt || true"
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/**.txt', allowEmptyArchive: true
                }
            }
        }

        stage('Unit Tests') {
            steps {
                script {
                    sh 'mkdir -p reports'
                    sh """
                        docker run --rm --volumes-from jenkins \
                        -w /var/jenkins_home/workspace/devops-ci-cd \
                        python:3.9 bash -lc ". venv/bin/activate && pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=html --junit-xml=reports/unit-tests.xml"

                    """
                }
            }
            post {
  always {
    junit 'reports/unit-tests.xml'
    archiveArtifacts artifacts: 'reports/**,coverage.xml,htmlcov/**', allowEmptyArchive: true
  }
}
        }
        stage('Integration Tests') {
            steps {
                script {
                    sh 'mkdir -p reports'
                    sh """
                        docker run --rm --volumes-from jenkins \
                        -w /var/jenkins_home/workspace/devops-ci-cd \
                        python:3.9 bash -lc ". venv/bin/activate && pytest tests/integration/ -v --junit-xml=reports/integration-tests.xml"

                    """
                }
            }
            post {
                always {
                    junit 'reports/integration-tests.xml'
                }
            }
        }

stage('End-to-End Tests') {
    steps {
        script {
            sh '''
                set -e
                mkdir -p reports

                echo "== Create docker network (if not exists) =="
                docker network create ci-net >/dev/null 2>&1 || true

                echo "== Cleanup old containers (if exist) =="
                docker rm -f selenium-firefox app-under-test >/dev/null 2>&1 || true

                echo "== Start App container =="
                docker run -d --name app-under-test \
                  --network ci-net \
                  --volumes-from jenkins \
                  -w /var/jenkins_home/workspace/devops-ci-cd \
                  -p 5000:5000 \
                  python:3.9 bash -lc ". venv/bin/activate && python main.py"

                echo "== Wait for app to be ready =="
                # Try up to ~30s
                for i in $(seq 1 30); do
                  if docker exec app-under-test bash -lc "python -c 'import urllib.request; urllib.request.urlopen(\"http://127.0.0.1:5000/health\"); print(\"ok\")'" >/dev/null 2>&1; then
                    echo "App is ready!"
                    break
                  fi
                  sleep 1
                done

                echo "== Start Selenium Firefox =="
                docker run -d --name selenium-firefox \
                  --network ci-net \
                  -p 4444:4444 \
                  selenium/standalone-firefox:latest

                echo "== Run E2E tests =="
                docker run --rm \
                  --network ci-net \
                  --volumes-from jenkins \
                  -w /var/jenkins_home/workspace/devops-ci-cd \
                  -e SELENIUM_REMOTE_URL=http://selenium-firefox:4444/wd/hub \
                  -e APP_BASE_URL=http://app-under-test:5000 \
                  python:3.9 bash -lc ". venv/bin/activate && pytest tests/e2e/ -v --junit-xml=reports/e2e-tests.xml"
            '''
        }
    }
    post {
        always {
            sh '''
                echo "== Stop containers (always) =="
                docker rm -f selenium-firefox app-under-test >/dev/null 2>&1 || true
            '''
            junit 'reports/e2e-tests.xml'
            archiveArtifacts artifacts: 'reports/e2e-tests.xml', allowEmptyArchive: true
        }
    }
}


        stage('Performance Tests') {
            when {
                allOf {
                    branch 'main'
                    expression { params.ENVIRONMENT == 'production' }
                }
            }
            steps {
                script {
                    sh """
                        docker run --rm -v "\$PWD":${APP_DIR} -w ${APP_DIR} ${PY_IMAGE} bash -lc '
                            . ${VENV_DIR}/bin/activate
                            python main.py &
                            APP_PID=\$!
                            sleep 5

                            mkdir -p reports

                            locust -f tests/performance/locustfile.py \
                                --headless \
                                --users 10 \
                                --spawn-rate 2 \
                                --run-time 30s \
                                --host http://localhost:5000 \
                                --html reports/performance-report.html

                            kill \$APP_PID || true
                        '
                    """
                }
            }
            post {
  always {
    archiveArtifacts artifacts: 'reports/performance-report.html', allowEmptyArchive: true
  }
}

        }






        stage('Security Scan') {
    steps {
        script {
            sh '''
                mkdir -p reports
                docker run --rm \
                  --volumes-from jenkins \
                  -w /var/jenkins_home/workspace/devops-ci-cd \
                  python:3.9 bash -lc ". venv/bin/activate && bandit -r app/ -f json -o reports/bandit-report.json || true"
            '''
        }
    }
    post {
        always {
            archiveArtifacts artifacts: 'reports/bandit-report.json', allowEmptyArchive: true
        }
    }
}


        stage('Create Version Tag') {
            when { branch 'main' }
            steps {
                script {
                    sh """
                        git config user.email "ci@jenkins"
                        git config user.name "jenkins-ci"

                        TAG="v1.0.${BUILD_NUMBER}"
                        git tag -a "\$TAG" -m "CI release \$TAG"
                        git tag --list | tail -n 5
                    """
                }
            }
        }

        stage('Build Docker Image') {
            when {
                allOf {
                    anyOf { branch 'main'; branch 'develop' }
                    expression { sh(script: 'command -v docker >/dev/null 2>&1', returnStatus: true) == 0 }
                }
            }
            steps {
                script {
                    sh '''
                        docker build -f docker/dockerfile -t devops-testing-app:${BUILD_NUMBER} .
                        docker tag devops-testing-app:${BUILD_NUMBER} devops-testing-app:latest
                    '''
                }
            }
        }

        stage('Push Docker Image (Docker Hub)') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKERHUB_CREDS}",
                        usernameVariable: 'DH_USER',
                        passwordVariable: 'DH_PASS'
                    )]) {
                        sh """
                            echo "\$DH_PASS" | docker login -u "\$DH_USER" --password-stdin

                            docker tag devops-testing-app:${BUILD_NUMBER} ${DOCKERHUB_REPO}:${BUILD_NUMBER}
                            docker tag devops-testing-app:${BUILD_NUMBER} ${DOCKERHUB_REPO}:latest

                            docker push ${DOCKERHUB_REPO}:${BUILD_NUMBER}
                            docker push ${DOCKERHUB_REPO}:latest

                            docker logout
                        """
                    }
                }
            }
        }

        stage('Deploy to Staging') {
            when {
                allOf {
                    branch 'develop'
                    expression { sh(script: 'command -v docker >/dev/null 2>&1', returnStatus: true) == 0 }
                }
            }
            steps {
                script {
                    sh '''
                        echo "Deploying to staging environment"
                        docker stop staging-app || true
                        docker rm staging-app || true
                        docker run -d --name staging-app -p 5001:5000 devops-testing-app:${BUILD_NUMBER}

                        sleep 5
                        curl -f http://localhost:5001/health || exit 1
                    '''
                }
            }
        }
    }

post {
  always {
    script {
      
      try {
        junit 'reports/*.xml'
      } catch (e) {
        echo "junit skipped: ${e}"
      }

      
      try {
        archiveArtifacts artifacts: 'reports/**, htmlcov/**, coverage.xml', fingerprint: true, allowEmptyArchive: true
      } catch (e) {
        echo "archiveArtifacts skipped: ${e}"
      }

      
      try {
        publishHTML(target: [
          allowMissing: true,
          alwaysLinkToLastBuild: true,
          keepAll: true,
          reportDir: 'htmlcov',
          reportFiles: 'index.html',
          reportName: 'Coverage Report'
        ])
      } catch (e) {
        echo "publishHTML (coverage) skipped: ${e}"
      }

      try {
        publishHTML(target: [
          allowMissing: true,
          alwaysLinkToLastBuild: true,
          keepAll: true,
          reportDir: 'reports',
          reportFiles: 'pytest_report.html',
          reportName: 'Pytest HTML Report'
        ])
      } catch (e) {
        echo "publishHTML (pytest) skipped: ${e}"
      }

      
      try {
        cleanWs()
      } catch (e) {
        echo "cleanWs skipped: ${e}"
      }
    }
  }

success {
  script {
    try {
      sh 'echo "Pipeline completed successfully!"'
    } catch (e) {
      echo "success post sh skipped: ${e}"
    }

    try {
      emailext (
        to: 'oefraty@gmail.com',
        recipientProviders: [],          
        from: 'oefraty@gmail.com',
        replyTo: 'oefraty@gmail.com',
        subject: "Pipeline Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
        mimeType: 'text/html',
        body: """
          <p>The pipeline completed successfully!</p>
          <ul>
            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
            <li><strong>Reports:</strong> See Jenkins build links: <b>Test Result</b>, <b>Coverage Report</b>, <b>Pytest HTML Report</b></li>
          </ul>
          <p><a href="${env.BUILD_URL}">View Build Details</a></p>
        """
      )
    } catch (e) {
      echo "success emailext skipped: ${e}"
    }
  }
}


  failure {
    script {
      
      try {
        emailext(
          subject: "FAILED: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
          mimeType: 'text/html',
          body: """
            <p><b>Pipeline failed</b></p>
            <ul>
              <li><strong>Build number:</strong> ${env.BUILD_NUMBER}</li>
              <li><strong>Branch name:</strong> ${env.BRANCH_NAME}</li>
              <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
              <li><strong>Failed stage:</strong> ${env.STAGE_NAME}</li>
              <li><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></li>
            </ul>
            <p>Reports are available in the build page: <b>Test Result</b>, <b>Coverage Report</b>, <b>Pytest HTML Report</b>, and <b>Artifacts</b>.</p>
          """,
          to: "oefraty@gmail.com"
        )
      } catch (e) {
        echo "failure emailext failed but pipeline continues: ${e}"
      }

      
      withCredentials([usernamePassword(credentialsId: 'jira-api-token',
                                        usernameVariable: 'JIRA_USER',
                                        passwordVariable: 'JIRA_TOKEN')]) {

        sh '''#!/bin/bash
set -e

JIRA_URL="https://oefraty.atlassian.net"
PROJECT_KEY="KAN"
ISSUE_TYPE="Task"

JOB_NAME_SAFE="${JOB_NAME:-unknown-job}"
BUILD_NUM_SAFE="${BUILD_NUMBER:-unknown-build}"
BUILD_URL_SAFE="${BUILD_URL:-unknown-url}"
BRANCH_SAFE="${BRANCH_NAME:-unknown-branch}"

SUMMARY="Jenkins Build Failed - ${JOB_NAME_SAFE} #${BUILD_NUM_SAFE}"

PAYLOAD=$(cat <<EOF
{
  "fields": {
    "project": { "key": "${PROJECT_KEY}" },
    "summary": "${SUMMARY}",
    "issuetype": { "name": "${ISSUE_TYPE}" },
    "description": {
      "type": "doc",
      "version": 1,
      "content": [
        { "type": "paragraph", "content": [ { "type": "text", "text": "Build URL: ${BUILD_URL_SAFE}" } ] },
        { "type": "paragraph", "content": [ { "type": "text", "text": "Branch: ${BRANCH_SAFE}" } ] },
        { "type": "paragraph", "content": [ { "type": "text", "text": "Status: FAILED" } ] }
      ]
    }
  }
}
EOF
)

curl -sS -X POST \
  -u "$JIRA_USER:$JIRA_TOKEN" \
  -H "Content-Type: application/json" \
  --data "$PAYLOAD" \
  "$JIRA_URL/rest/api/3/issue"
'''
      }
    }
  }
}


}
